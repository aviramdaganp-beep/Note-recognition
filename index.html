<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>iPhone Pitch Detector (YIN)</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; padding: 18px; }
    button { width: 100%; padding: 16px; font-size: 20px; border: 0; border-radius: 14px; font-weight: 800; }
    .card { margin-top: 14px; padding: 16px; border: 1px solid #e6e6e6; border-radius: 14px; }
    .note { font-size: 52px; font-weight: 900; line-height: 1.1; }
    .muted { color: #666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .row { margin-top: 10px; }
    .hint { margin-top: 10px; font-size: 14px; color: #666; }
    .ver { margin: 6px 0 10px; color: #b00000; font-weight: 900; }
  </style>
</head>
<body>
  <div class="ver">VERSION YIN 1</div>

  <h2 style="margin:0 0 6px 0;">×–×™×”×•×™ ×¦×œ×™×œ ××”××™×§×¨×•×¤×•×Ÿ (××™×™×¤×•×Ÿ)</h2>
  <div class="muted">×—×™×™×‘ HTTPS. ×¢×“×™×£ ×œ×¤×ª×•×— ×‘-Safari. ×œ×—×¥ â€œ×”×ª×—×œâ€.</div>

  <button id="btn">ğŸ¤ ×”×ª×—×œ</button>

  <div class="card">
    <div class="note" id="note">â€”</div>

    <div class="row">Hz: <span class="mono" id="freq">â€”</span></div>
    <div class="row">Cents: <span class="mono" id="cents">â€”</span></div>

    <div class="row">Clarity (prob): <span class="mono" id="clarity">â€”</span></div>
    <div class="row">RMS: <span class="mono" id="rms">â€”</span></div>

    <div class="row muted">Status: <span class="mono" id="status">×œ× ×¤×¢×™×œ</span></div>
    <div class="hint">×˜×™×¤: ×ª×• ×‘×•×“×“ ×•×™×¦×™×‘ (×©×¨×™×§×” / â€œ××•Ö¼â€ / ×¤×¡× ×ª×¨ ×ª×• ××—×“). ××•×–×™×§×”/××§×•×¨×“×™× ×™×§×¤×™×¦×•.</div>
  </div>

  <!-- iOS hint -->
  <audio playsinline></audio>

<script>
(() => {
  const btn = document.getElementById("btn");
  const noteEl = document.getElementById("note");
  const freqEl = document.getElementById("freq");
  const centsEl = document.getElementById("cents");
  const clarityEl = document.getElementById("clarity");
  const rmsEl = document.getElementById("rms");
  const statusEl = document.getElementById("status");

  const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  const FFT_SIZE = 2048;              // try 4096 if you want better low-note stability
  const buf = new Float32Array(FFT_SIZE);

  // Gates
  const RMS_GATE = 0.005;             // silence gate
  const YIN_THRESHOLD = 0.12;         // higher = more sensitive, lower = stricter
  const YIN_PROB_GATE = 0.55;         // show note only above this
  const MAX_JUMP_RATIO = 2.0;         // ignore insane jumps
  const SMOOTH_ALPHA = 0.25;          // display smoothing

  let audioCtx = null;
  let analyser = null;
  let stream = null;
  let rafId = null;
  let running = false;

  let smoothedFreq = null;

  btn.addEventListener("click", async () => {
    if (running) return stop();

    try {
      if (!window.isSecureContext) {
        statusEl.textContent = "×¦×¨×™×š HTTPS (×œ× ×¢×•×‘×“ ×-file://).";
        return;
      }

      statusEl.textContent = "××‘×§×© ×’×™×©×” ×œ××™×§×¨×•×¤×•×Ÿâ€¦";

      // iOS: keep constraints minimal
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") await audioCtx.resume();

      const src = audioCtx.createMediaStreamSource(stream);

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = FFT_SIZE;
      analyser.smoothingTimeConstant = 0.15;

      src.connect(analyser);

      running = true;
      btn.textContent = "â¹ ×¢×¦×•×¨";
      statusEl.textContent = "×××–×™×Ÿâ€¦";
      loop();
    } catch (e) {
      statusEl.textContent = "×©×’×™××”: " + (e?.name ? `${e.name}: ` : "") + (e?.message || e);
    }
  });

  function loop() {
    analyser.getFloatTimeDomainData(buf);

    const res = detectPitchYIN(buf, audioCtx.sampleRate);
    const freq = res.freq;
    const prob = res.prob;
    const rms = res.rms;

    rmsEl.textContent = rms.toFixed(4);
    clarityEl.textContent = prob.toFixed(2);

    if (freq && rms >= RMS_GATE && prob >= YIN_PROB_GATE) {
      // reject crazy jumps
      if (smoothedFreq && (freq / smoothedFreq > MAX_JUMP_RATIO || smoothedFreq / freq > MAX_JUMP_RATIO)) {
        // ignore this frame
      } else {
        smoothedFreq = smoothedFreq == null ? freq : (smoothedFreq * (1 - SMOOTH_ALPHA) + freq * SMOOTH_ALPHA);

        const midi = freqToMidi(smoothedFreq);
        const name = midiToNoteName(midi);
        const ref = midiToFreq(midi);
        const cents = centsOff(smoothedFreq, ref);

        noteEl.textContent = name;
        freqEl.textContent = smoothedFreq.toFixed(2);
        centsEl.textContent = (cents >= 0 ? "+" : "") + cents.toFixed(1);
      }
    } else {
      noteEl.textContent = "â€”";
      freqEl.textContent = "â€”";
      centsEl.textContent = "â€”";
      smoothedFreq = null;
    }

    rafId = requestAnimationFrame(loop);
  }

  function stop() {
    running = false;
    btn.textContent = "ğŸ¤ ×”×ª×—×œ";
    statusEl.textContent = "×œ× ×¤×¢×™×œ";

    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;

    if (audioCtx) audioCtx.close();
    audioCtx = null;

    analyser = null;
    smoothedFreq = null;

    noteEl.textContent = "â€”";
    freqEl.textContent = "â€”";
    centsEl.textContent = "â€”";
    clarityEl.textContent = "â€”";
    rmsEl.textContent = "â€”";
  }

  // -----------------------
  // YIN pitch detection
  // Returns: { freq, prob, rms }
  // -----------------------
  function detectPitchYIN(signal, sampleRate) {
    // DC removal + RMS
    let mean = 0;
    for (let i = 0; i < signal.length; i++) mean += signal[i];
    mean /= signal.length;

    const x = new Float32Array(signal.length);
    let rms = 0;
    for (let i = 0; i < signal.length; i++) {
      const v = signal[i] - mean;
      x[i] = v;
      rms += v * v;
    }
    rms = Math.sqrt(rms / signal.length);
    if (rms < RMS_GATE) return { freq: null, prob: 0, rms };

    const n = x.length;
    const maxTau = Math.floor(n / 2);

    // difference function
    const d = new Float32Array(maxTau);
    for (let tau = 1; tau < maxTau; tau++) {
      let sum = 0;
      for (let i = 0; i < maxTau; i++) {
        const delta = x[i] - x[i + tau];
        sum += delta * delta;
      }
      d[tau] = sum;
    }

    // CMNDF
    const cmndf = new Float32Array(maxTau);
    cmndf[0] = 1;
    let runningSum = 0;
    for (let tau = 1; tau < maxTau; tau++) {
      runningSum += d[tau];
      cmndf[tau] = d[tau] * tau / (runningSum || 1e-12);
    }

    // absolute threshold
    let tauEstimate = -1;
    for (let tau = 2; tau < maxTau; tau++) {
      if (cmndf[tau] < YIN_THRESHOLD) {
        while (tau + 1 < maxTau && cmndf[tau + 1] < cmndf[tau]) tau++;
        tauEstimate = tau;
        break;
      }
    }
    if (tauEstimate === -1) return { freq: null, prob: 0, rms };

    const betterTau = parabolicTau(cmndf, tauEstimate);
    const freq = sampleRate / betterTau;

    // probability of periodicity (1 = very periodic)
    const prob = clamp01(1 - cmndf[tauEstimate]);

    if (freq < 50 || freq > 2000) return { freq: null, prob: 0, rms };
    return { freq, prob, rms };
  }

  function parabolicTau(arr, tau) {
    const x0 = tau > 1 ? tau - 1 : tau;
    const x2 = tau + 1 < arr.length ? tau + 1 : tau;
    if (x0 === tau || x2 === tau) return tau;

    const s0 = arr[x0], s1 = arr[tau], s2 = arr[x2];
    const denom = (s0 - 2 * s1 + s2);
    if (denom === 0) return tau;

    const delta = 0.5 * (s0 - s2) / denom;
    return tau + delta;
  }

  // -----------------------
  // Note helpers
  // -----------------------
  function freqToMidi(f) { return Math.round(69 + 12 * Math.log2(f / 440)); }
  function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }
  function midiToNoteName(m) {
    const name = NOTE_NAMES[(m % 12 + 12) % 12];
    const octave = Math.floor(m / 12) - 1;
    return `${name}${octave}`;
  }
  function centsOff(f, ref) { return 1200 * Math.log2(f / ref); }
  function clamp01(x) { return Math.max(0, Math.min(1, x)); }

  window.addEventListener("pagehide", stop);
})();
</script>
</body>
</html>
